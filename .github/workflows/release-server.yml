name: Aether Identity Server Release

on:
  push:
    paths:
      - "server/**"
    tags:
      - "v*.*.*-server"

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25.5"

      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_without_suffix=${VERSION%-server}" >> $GITHUB_OUTPUT

      - name: Build server
        run: |
          cd server
          go mod tidy
          go build -o identity-server .

      - name: Build Docker image
        run: |
          cd server/infra
          docker build -t ghcr.io/${{ github.repository }}/server:${{ steps.version.outputs.version }} .
          docker tag ghcr.io/${{ github.repository }}/server:${{ steps.version.outputs.version }} ghcr.io/${{ github.repository }}/server:latest

      - name: Log in to GitHub Container Registry
        if: github.repository_owner == 'skygenesisenterprise'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push Docker image to GitHub Container Registry
        if: github.repository_owner == 'skygenesisenterprise'
        run: |
          docker push ghcr.io/${{ github.repository }}/server:${{ steps.version.outputs.version }}
          docker push ghcr.io/${{ github.repository }}/server:latest

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Aether Identity Server Release ${{ steps.version.outputs.version_without_suffix }}
          body: |
            ## üöÄ Aether Identity Server Release ${{ steps.version.outputs.version_without_suffix }}

            ### üê≥ Docker Deployment
            ```bash
            # Pull the latest image
            docker pull ghcr.io/${{ github.repository }}/server:${{ steps.version.outputs.version }}

            # Or use latest
            docker pull ghcr.io/${{ github.repository }}/server:latest

            # Run the container
            docker run -d \
              --name aether-server \
              -p 8080:8080 \
              ghcr.io/${{ github.repository }}/server:${{ steps.version.outputs.version }}
            ```

            ### üîó Links
            - [Docker Image](https://github.com/${{ github.repository }}/pkgs/container/server)
          draft: false
          prerelease: false
          generate_release_notes: true
