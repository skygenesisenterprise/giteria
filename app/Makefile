# Makefile pour la gestion du dÃ©veloppement Docker de l'application Next.js
# Ce Makefile fournit des commandes claires et organisÃ©es pour le dÃ©veloppement

# Couleurs pour une meilleure lisibilitÃ©
GREEN  := \033[0;32m
YELLOW := \033[1;33m
BLUE   := \033[0;34m
MAGENTA := \033[0;35m
CYAN   := \033[0;36m
RED    := \033[0;31m
RESET  := \033[0m

# Variables de base
APP_DIR := $(shell pwd)
DOCKER_COMPOSE := docker compose

# Mode par dÃ©faut (dev ou prod)
MODE ?= dev

# Fichiers Docker Compose en fonction du mode
DOCKER_COMPOSE_FILE := infra/docker-compose.$(MODE).yml

# Nom du conteneur
CONTAINER_NAME := aether-identity-frontend-$(MODE)

.PHONY: help
help: ## Afficher l'aide pour les commandes disponibles
	@echo "${GREEN}========================================${RESET}"
	@echo "${GREEN}Makefile pour Aether Identity - Application Next.js${RESET}"
	@echo "${GREEN}========================================${RESET}"
	@echo ""
	@echo "${BLUE}ğŸ“‹ Mode actuel: $(MODE)${RESET}"
	@echo ""
	@echo "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
	@echo "${CYAN}ğŸš€ COMMANDES PRINCIPALES${RESET}"
	@echo "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
	@echo ""
	@echo "  ${YELLOW}make up${RESET}                    ${GREEN}# Lancer le conteneur en mode $(MODE)${RESET}"
	@echo "  ${YELLOW}make down${RESET}                  ${GREEN}# ArrÃªter et supprimer les conteneurs${RESET}"
	@echo "  ${YELLOW}make restart${RESET}               ${GREEN}# RedÃ©marrer le conteneur${RESET}"
	@echo "  ${YELLOW}make rebuild${RESET}               ${GREEN}# Reconstruire et relancer le conteneur${RESET}"
	@echo ""
	@echo "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
	@echo "${CYAN}ğŸ“Š MONITORING ET LOGS${RESET}"
	@echo "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
	@echo ""
	@echo "  ${YELLOW}make logs${RESET}                  ${GREEN}# Afficher les logs du conteneur${RESET}"
	@echo "  ${YELLOW}make logs-follow${RESET}            ${GREEN}# Suivre les logs en temps rÃ©el${RESET}"
	@echo "  ${YELLOW}make status${RESET}                ${GREEN}# Afficher le statut des conteneurs${RESET}"
	@echo "  ${YELLOW}make ps${RESET}                    ${GREEN}# Lister les conteneurs en cours d'exÃ©cution${RESET}"
	@echo ""
	@echo "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
	@echo "${CYAN}ğŸ”§ GESTION DOCKER${RESET}"
	@echo "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
	@echo ""
	@echo "  ${YELLOW}make build${RESET}                 ${GREEN}# Construire l'image Docker${RESET}"
	@echo "  ${YELLOW}make clean${RESET}                 ${GREEN}# Nettoyer les images Docker inutilisÃ©es${RESET}"
	@echo "  ${YELLOW}make prune${RESET}                 ${GREEN}# Nettoyer complÃ¨tement (images, conteneurs, volumes)${RESET}"
	@echo ""
	@echo "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
	@echo "${CYAN}ğŸ”Œ GESTION DES PORTS${RESET}"
	@echo "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
	@echo ""
	@echo "  ${YELLOW}make ports${RESET}                 ${GREEN}# VÃ©rifier les ports utilisÃ©s${RESET}"
	@echo "  ${YELLOW}make kill-ports${RESET}            ${GREEN}# Forcer la libÃ©ration du port 3000${RESET}"
	@echo ""
	@echo "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
	@echo "${CYAN}ğŸ’» ACCÃˆS AU CONTENAIR${RESET}"
	@echo "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
	@echo ""
	@echo "  ${YELLOW}make exec${RESET}                  ${GREEN}# ExÃ©cuter une commande dans le conteneur${RESET}"
	@echo "  ${YELLOW}make shell${RESET}                 ${GREEN}# Ouvrir un shell dans le conteneur${RESET}"
	@echo "  ${YELLOW}make bash${RESET}                  ${GREEN}# Ouvrir un bash dans le conteneur${RESET}"
	@echo ""
	@echo "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
	@echo "${CYAN}âš™ï¸  GESTION DU MODE${RESET}"
	@echo "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
	@echo ""
	@echo "  ${YELLOW}make dev${RESET}                   ${GREEN}# Basculer en mode dÃ©veloppement${RESET}"
	@echo "  ${YELLOW}make prod${RESET}                  ${GREEN}# Basculer en mode production${RESET}"
	@echo "  ${YELLOW}make mode=dev up${RESET}           ${GREEN}# Lancer en mode dÃ©veloppement (override)${RESET}"
	@echo "  ${YELLOW}make mode=prod up${RESET}          ${GREEN}# Lancer en mode production (override)${RESET}"
	@echo ""
	@echo "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
	@echo "${CYAN}ğŸ” INFORMATIONS${RESET}"
	@echo "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
	@echo ""
	@echo "  ${YELLOW}make version${RESET}               ${GREEN}# Afficher les versions de Docker${RESET}"
	@echo "  ${YELLOW}make info${RESET}                  ${GREEN}# Afficher des informations sur le systÃ¨me${RESET}"
	@echo ""
	@echo "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
	@echo "${CYAN}ğŸ“š EXEMPLES D'UTILISATION${RESET}"
	@echo "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
	@echo ""
	@echo "  ${MAGENTA}# DÃ©marrer en mode dÃ©veloppement${RESET}"
	@echo "  ${GREEN}make up${RESET}"
	@echo ""
	@echo "  ${MAGENTA}# DÃ©marrer en mode production${RESET}"
	@echo "  ${GREEN}make mode=prod up${RESET}"
	@echo ""
	@echo "  ${MAGENTA}# Reconstruire et redÃ©marrer${RESET}"
	@echo "  ${GREEN}make rebuild${RESET}"
	@echo ""
	@echo "  ${MAGENTA}# Voir les logs en temps rÃ©el${RESET}"
	@echo "  ${GREEN}make logs-follow${RESET}"
	@echo ""
	@echo "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
	@echo ""
	@echo "${RED}ğŸ’¡ Astuce: Utilisez 'make help' Ã  tout moment pour afficher cette aide${RESET}"
	@echo ""

.PHONY: up
up: ## Lancer le conteneur en mode $(MODE)
	@echo "${GREEN}ğŸš€ Lancement du conteneur Next.js en mode $(MODE)...${RESET}"
	@echo "${YELLOW}Utilisation du fichier: $(DOCKER_COMPOSE_FILE)${RESET}"
	@cd $(APP_DIR) && $(DOCKER_COMPOSE) -f $(DOCKER_COMPOSE_FILE) up -d --build
	@echo "${GREEN}âœ… Conteneur dÃ©marrÃ©: $(CONTAINER_NAME)${RESET}"
	@echo "${GREEN}ğŸŒ AccÃ¨s Ã  l'application:${RESET}"
	@echo "   - http://localhost:3000 (Next.js direct)"
	@echo ""
	@echo "${GREEN}ğŸ“ Pour suivre les logs: make logs-follow${RESET}"

.PHONY: down
down: ## ArrÃªter et supprimer les conteneurs
	@echo "${GREEN}ğŸ›‘ ArrÃªt et suppression des conteneurs...${RESET}"
	@cd $(APP_DIR) && $(DOCKER_COMPOSE) -f $(DOCKER_COMPOSE_FILE) down
	@echo "${GREEN}âœ… Conteneurs arrÃªtÃ©s et supprimÃ©s${RESET}"

.PHONY: restart
restart: down up ## RedÃ©marrer le conteneur

.PHONY: rebuild
rebuild: ## Reconstruire et relancer le conteneur
	@echo "${GREEN}ğŸ”„ Reconstruction et redÃ©marrage du conteneur...${RESET}"
	@echo "${YELLOW}Nettoyage des conteneurs existants...${RESET}"
	@cd $(APP_DIR) && $(DOCKER_COMPOSE) -f $(DOCKER_COMPOSE_FILE) down --remove-orphans
	@echo "${YELLOW}Construction de l'image avec cache nettoyÃ©...${RESET}"
	@cd $(APP_DIR) && $(DOCKER_COMPOSE) -f $(DOCKER_COMPOSE_FILE) build --no-cache
	@echo "${YELLOW}DÃ©marrage du conteneur...${RESET}"
	@cd $(APP_DIR) && $(DOCKER_COMPOSE) -f $(DOCKER_COMPOSE_FILE) up -d
	@echo "${GREEN}âœ… Reconstruction terminÃ©e${RESET}"

.PHONY: build
build: ## Construire l'image Docker
	@echo "${GREEN}ğŸ”¨ Construction de l'image Docker...${RESET}"
	@cd $(APP_DIR) && $(DOCKER_COMPOSE) -f $(DOCKER_COMPOSE_FILE) build
	@echo "${GREEN}âœ… Image Docker construite avec succÃ¨s${RESET}"

.PHONY: logs
logs: ## Afficher les logs du conteneur
	@echo "${GREEN}ğŸ“‹ Affichage des logs (derniÃ¨res 100 lignes)...${RESET}"
	@cd $(APP_DIR) && $(DOCKER_COMPOSE) -f $(DOCKER_COMPOSE_FILE) logs --tail=100

.PHONY: logs-follow
logs-follow: ## Suivre les logs en temps rÃ©el
	@echo "${GREEN}ğŸ“‹ Suivi des logs en temps rÃ©el...${RESET}"
	@echo "${RED}Appuyez sur Ctrl+C pour arrÃªter le suivi${RESET}"
	@cd $(APP_DIR) && $(DOCKER_COMPOSE) -f $(DOCKER_COMPOSE_FILE) logs -f

.PHONY: status
status: ## Afficher le statut des conteneurs
	@echo "${GREEN}ğŸ“Š Statut des conteneurs...${RESET}"
	@cd $(APP_DIR) && $(DOCKER_COMPOSE) -f $(DOCKER_COMPOSE_FILE) ps

.PHONY: ps
ps: ## Lister les conteneurs en cours d'exÃ©cution
	@echo "${GREEN}ğŸ“Š Liste des conteneurs en cours d'exÃ©cution...${RESET}"
	docker ps --format "table {{.ID}}\t{{.Names}}\t{{.Status}}\t{{.Ports}}"

.PHONY: ports
ports: ## VÃ©rifier les ports utilisÃ©s
	@echo "${GREEN}ğŸ” VÃ©rification des ports utilisÃ©s...${RESET}"
	@echo ""
	@echo "${BLUE}Ports utilisÃ©s par Docker:${RESET}"
	@docker ps --format "{{.Names}}: {{.Ports}}"
	@echo ""
	@echo "${BLUE}Processus utilisant le port 3000:${RESET}"
	@lsof -i :3000 || echo "${GREEN}âœ… Port 3000 disponible${RESET}"
	@echo ""
	@echo "${YELLOW}Si le port est utilisÃ©, vous pouvez le libÃ©rer avec:${RESET}"
	@echo "  ${GREEN}fuser -k 3000/tcp${RESET} (Linux)"
	@echo "  ${GREEN}lsof -i :3000 | grep -v PID | awk '{print $$2}' | xargs kill -9${RESET}"

.PHONY: exec
exec: ## ExÃ©cuter une commande dans le conteneur
	@echo "${GREEN}ğŸ’» ExÃ©cution d'une commande dans le conteneur...${RESET}"
	@cd $(APP_DIR) && $(DOCKER_COMPOSE) -f $(DOCKER_COMPOSE_FILE) exec app sh -c "$@"

.PHONY: shell
shell: ## Ouvrir un shell dans le conteneur
	@echo "${GREEN}ğŸ’» Ouverture d'un shell dans le conteneur...${RESET}"
	@cd $(APP_DIR) && $(DOCKER_COMPOSE) -f $(DOCKER_COMPOSE_FILE) exec app sh

.PHONY: bash
bash: ## Ouvrir un bash dans le conteneur
	@echo "${GREEN}ğŸ’» Ouverture d'un bash dans le conteneur...${RESET}"
	@cd $(APP_DIR) && $(DOCKER_COMPOSE) -f $(DOCKER_COMPOSE_FILE) exec app bash

.PHONY: clean
clean: ## Nettoyer les images Docker inutilisÃ©es
	@echo "${GREEN}ğŸ§¹ Nettoyage des images Docker inutilisÃ©es...${RESET}"
	docker system prune -f
	@echo "${GREEN}âœ… Nettoyage terminÃ©${RESET}"

.PHONY: prune
prune: ## Nettoyer complÃ¨tement (images, conteneurs, volumes)
	@echo "${RED}âš ï¸  Attention: Cette commande supprime TOUT (images, conteneurs, volumes, rÃ©seaux)${RESET}"
	@echo "${YELLOW}Confirmez-vous? (o/n)${RESET}"
	@read -r REPLY
	if [ "$$REPLY" = "o" ] || [ "$$REPLY" = "O" ]; then
		@echo "${GREEN}ğŸ§¹ Nettoyage complet en cours...${RESET}"
		docker system prune -a -f --volumes
		@echo "${GREEN}âœ… Nettoyage complet terminÃ©${RESET}"
	else
		@echo "${GREEN}âœ… Nettoyage annulÃ©${RESET}"
	fi

.PHONY: kill-ports
kill-ports: ## Forcer la libÃ©ration du port 3000
	@echo "${RED}âš ï¸  Attention: Cette commande tue les processus utilisant le port 3000${RESET}"
	@echo "${YELLOW}Confirmez-vous? (o/n)${RESET}"
	@read -r REPLY
	if [ "$$REPLY" = "o" ] || [ "$$REPLY" = "O" ]; then
		@echo "${GREEN}ğŸ”¥ LibÃ©ration du port en cours...${RESET}"
		@echo "${YELLOW}Port 3000:${RESET}"
		@lsof -ti :3000 | xargs -r kill -9
		@echo "${GREEN}âœ… Port libÃ©rÃ©${RESET}"
	else
		@echo "${GREEN}âœ… OpÃ©ration annulÃ©e${RESET}"
	fi

.PHONY: dev
dev: ## Basculer en mode dÃ©veloppement
	@echo "${GREEN}âš™ï¸  Basculer en mode dÃ©veloppement...${RESET}"
	@export MODE=dev
	@echo "${GREEN}âœ… Mode dÃ©veloppÃ© dÃ©fini: dev${RESET}"
	@echo "${YELLOW}Utilisez 'make up' pour appliquer ce changement${RESET}"

.PHONY: prod
prod: ## Basculer en mode production
	@echo "${GREEN}âš™ï¸  Basculer en mode production...${RESET}"
	@export MODE=prod
	@echo "${GREEN}âœ… Mode dÃ©veloppÃ© dÃ©fini: prod${RESET}"
	@echo "${YELLOW}Utilisez 'make up' pour appliquer ce changement${RESET}"

.PHONY: version
version: ## Afficher les versions de Docker
	@echo "${GREEN}ğŸ“‹ Versions de Docker...${RESET}"
	docker --version
	docker compose version
	@echo ""

.PHONY: info
info: ## Afficher des informations sur le systÃ¨me
	@echo "${GREEN}ğŸ“Š Informations systÃ¨me...${RESET}"
	@echo ""
	@echo "${BLUE}Docker Information:${RESET}"
	docker info --format '{{.Driver}}: {{.DriverStatus}}'
	@echo ""
	@echo "${BLUE}Conteneurs en cours d'exÃ©cution:${RESET}"
	docker ps --format "{{.Names}}"
	@echo ""
	@echo "${BLUE}Images disponibles:${RESET}"
	docker images --format "{{.Repository}}:{{.Tag}}"
	@echo ""

.PHONY: reset
reset: clean prune ## RÃ©initialiser complÃ¨tement l'environnement Docker

# Alias pour les commandes courantes
.PHONY: start
start: up

.PHONY: stop
stop: down

.PHONY: rebuild-force
rebuild-force: clean rebuild

.PHONY: force-rebuild
force-rebuild: kill-ports rebuild ## Reconstruction forcÃ©e avec libÃ©ration des ports
