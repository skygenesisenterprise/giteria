# Redis Production Configuration for Aether Mailer
# Optimized for production environment with security and performance

# Network Configuration
bind 0.0.0.0
port 6379
protected-mode yes

# Security Configuration (production)
requirepass ${REDIS_PASSWORD}
# Rename dangerous commands for security
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command DEBUG ""
rename-command CONFIG "CONFIG_b835c3f9a8"
rename-command SHUTDOWN "SHUTDOWN_b835c3f9a8"
rename-command MODULE "MODULE_b835c3f9a8"

# TLS Configuration (uncomment for production with SSL)
# port 0
# tls-port 6380
# tls-cert-file /etc/ssl/redis/redis.crt
# tls-key-file /etc/ssl/redis/redis.key
# tls-ca-cert-file /etc/ssl/redis/ca.crt
# tls-dh-params-file /etc/ssl/redis/dh.pem
# tls-protocols "TLSv1.2 TLSv1.3"
# tls-ciphers "ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256"
# tls-ciphersuites "TLS_AES_256_GCM_SHA384:TLS_AES_128_GCM_SHA256"
# tls-prefer-server-ciphers yes

# General Configuration
daemonize yes
pidfile /var/run/redis/redis-server.pid
loglevel notice
logfile /var/log/redis/redis-server.log
syslog-enabled yes
syslog-ident redis
syslog-facility local0

# Database Configuration
databases 8
save 900 1
save 300 10
save 60 10000

# Memory Management
maxmemory ${REDIS_MAX_MEMORY:-2gb}
maxmemory-policy allkeys-lru
maxmemory-samples 5

# Persistence Configuration
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /var/lib/redis/

# AOF Persistence (critical for production)
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes
aof-use-rdb-preamble yes

# Replication Configuration (for high availability)
# replica-serve-stale-data yes
# replica-read-only yes
# repl-diskless-sync yes
# repl-diskless-sync-delay 5
# repl-ping-replica-period 10
# repl-timeout 60
# repl-backlog-size 10mb
# repl-backlog-ttl 3600
# min-replicas-to-write 1
# min-replicas-max-lag 10

# Client Configuration
timeout 300
tcp-keepalive 300
tcp-backlog 511
maxclients 10000

# Slow Log Configuration
slowlog-log-slower-than 10000
slowlog-max-len 128

# Latency Monitoring
latency-monitor-threshold 100

# Event Notification (limited for production)
notify-keyspace-events "Ex"

# Production Optimizations
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
hll-sparse-max-bytes 3000
stream-node-max-bytes 4096
stream-node-max-entries 100

# Active Rehashing
activerehashing yes

# Client Output Buffer Limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Client Query Buffer Limit
client-query-buffer-limit 1gb

# Protocol Max Bulk Request Size
proto-max-bulk-len 512mb

# Frequency of rehashing
hz 10

# Dynamic HZ
dynamic-hz yes

# AOF Rewrite Incremental fsync
aof-rewrite-incremental-fsync yes

# RDB Save Incremental fsync
rdb-save-incremental-fsync yes

# Production TTL values
session:ttl 86400           # 24 hours
cache:ttl 3600              # 1 hour
rate-limit:window 900      # 15 minutes
rate-limit:max 100          # Production rate limiting
api-cache:ttl 300          # 5 minutes
health:ttl 60              # 1 minute
metrics:ttl 300            # 5 minutes
security-events:ttl 604800 # 7 days
domain-verify:ttl 86400    # 24 hours
email-verify:ttl 3600      # 1 hour
password-reset:ttl 1800    # 30 minutes
2fa:ttl 300               # 5 minutes
api-keys:ttl 0            # No expiration for API keys
temp:ttl 300              # 5 minutes
notifications:ttl 86400   # 24 hours
search:ttl 1800           # 30 minutes
audit:ttl 2592000         # 30 days
perf:ttl 300              # 5 minutes

# Production Security Settings
# Enable command stats for monitoring
# CONFIG SET commandstats yes

# Production Cluster Configuration (uncomment for Redis Cluster)
# cluster-enabled yes
# cluster-config-file nodes-6379.conf
# cluster-node-timeout 15000
# cluster-announce-ip ${REDIS_CLUSTER_IP}
# cluster-announce-port 6379
# cluster-announce-bus-port 16379
# cluster-replica-validity-factor 10
# cluster-migration-barrier 1
# cluster-require-full-coverage yes

# Production Sentinel Configuration (uncomment for Redis Sentinel)
# port 26379
# sentinel monitor mymaster redis-master 6379 2
# sentinel down-after-milliseconds mymaster 5000
# sentinel failover-timeout mymaster 10000
# sentinel parallel-syncs mymaster 1
# sentinel auth-pass mymaster ${REDIS_SENTINEL_PASSWORD}
# sentinel notification-script mymaster /etc/redis/sentinel-notify.sh
# sentinel client-reconfig-script mymaster /etc/redis/sentinel-reconfig.sh

# Production Modules Configuration
# loadmodule /usr/lib/redis-modules/redisearch.so
# loadmodule /usr/lib/redis-modules/redisjson.so
# loadmodule /usr/lib/redis-modules/redistimeseries.so

# Production Monitoring
# Enable detailed monitoring
# CONFIG SET latency-monitor-threshold 100
# CONFIG SET slowlog-log-slower-than 10000

# Production Backup Configuration
# Backup every 6 hours
save 21600 1
save 3600 10
save 600 10000

# Production Performance Settings
# Optimize for production workloads
# CONFIG SET hash-max-ziplist-entries 512
# CONFIG SET zset-max-ziplist-entries 128

# Production Memory Optimization
# Optimize memory usage
# CONFIG SET maxmemory-policy allkeys-lru
# CONFIG SET maxmemory-samples 5

# Production Connection Settings
# Optimize for production connections
# CONFIG SET tcp-keepalive 300
# CONFIG SET timeout 300

# Production Persistence Settings
# Optimize for production persistence
# CONFIG SET save "900 1 300 10 60 10000"
# CONFIG SET appendonly yes
# CONFIG SET appendfsync everysec

# Production Security Settings
# Optimize for production security
# CONFIG SET protected-mode yes
# CONFIG SET requirepass ${REDIS_PASSWORD}

# Production Logging Settings
# Optimize for production logging
# CONFIG SET loglevel notice
# CONFIG SET syslog-enabled yes

# Production Replication Settings
# Optimize for production replication
# CONFIG SET replica-serve-stale-data yes
# CONFIG SET replica-read-only yes

# Production Cluster Settings
# Optimize for production clustering
# CONFIG SET cluster-enabled yes
# CONFIG SET cluster-node-timeout 15000

# Production Sentinel Settings
# Optimize for production sentinel
# CONFIG SET sentinel monitor mymaster redis-master 6379 2
# CONFIG SET sentinel down-after-milliseconds mymaster 5000

# Production Module Settings
# Optimize for production modules
# CONFIG SET search-max-results 1000
# CONFIG SET json-max-memory 100mb

# Production Monitoring Settings
# Optimize for production monitoring
# CONFIG SET latency-monitor-threshold 100
# CONFIG SET slowlog-max-len 128

# Production Backup Settings
# Optimize for production backup
# CONFIG SET rdbcompression yes
# CONFIG SET rdbchecksum yes

# Production Security Settings
# Optimize for production security
# CONFIG SET rename-command FLUSHDB ""
# CONFIG SET rename-command FLUSHALL ""
# CONFIG SET rename-command KEYS ""

# Production Performance Settings
# Optimize for production performance
# CONFIG SET activerehashing yes
# CONFIG SET dynamic-hz yes

# Production Memory Settings
# Optimize for production memory
# CONFIG SET maxmemory-policy allkeys-lru
# CONFIG SET maxmemory-samples 5

# Production Connection Settings
# Optimize for production connections
# CONFIG SET maxclients 10000
# CONFIG SET tcp-backlog 511

# Production Persistence Settings
# Optimize for production persistence
# CONFIG SET aof-rewrite-incremental-fsync yes
# CONFIG SET rdb-save-incremental-fsync yes

# Production Security Settings
# Optimize for production security
# CONFIG SET protected-mode yes
# CONFIG SET requirepass ${REDIS_PASSWORD}

# Production Logging Settings
# Optimize for production logging
# CONFIG SET loglevel notice
# CONFIG SET syslog-enabled yes

# Production Monitoring Settings
# Optimize for production monitoring
# CONFIG SET latency-monitor-threshold 100
# CONFIG SET slowlog-max-len 128

# Production Performance Settings
# Optimize for production performance
# CONFIG SET activerehashing yes
# CONFIG SET dynamic-hz yes

# Production Memory Settings
# Optimize for production memory
# CONFIG SET maxmemory-policy allkeys-lru
# CONFIG SET maxmemory-samples 5

# Production Connection Settings
# Optimize for production connections
# CONFIG SET maxclients 10000
# CONFIG SET tcp-backlog 511

# Production Persistence Settings
# Optimize for production persistence
# CONFIG SET aof-rewrite-incremental-fsync yes
# CONFIG SET rdb-save-incremental-fsync yes

# Production Security Settings
# Optimize for production security
# CONFIG SET protected-mode yes
# CONFIG SET requirepass ${REDIS_PASSWORD}

# Production Logging Settings
# Optimize for production logging
# CONFIG SET loglevel notice
# CONFIG SET syslog-enabled yes

# Production Monitoring Settings
# Optimize for production monitoring
# CONFIG SET latency-monitor-threshold 100
# CONFIG SET slowlog-max-len 128