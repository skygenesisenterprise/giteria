# Redis Configuration for Aether Vault
# Global Redis configuration file

# Network Configuration
bind 0.0.0.0
port 6379
protected-mode yes

# Security Configuration
requirepass ${REDIS_PASSWORD:-aether-redis-2025}
# Uncomment for production with strong password
# requirepass ${REDIS_PASSWORD}

# TLS Configuration (uncomment for production)
# port 0
# tls-port 6380
# tls-cert-file /path/to/redis.crt
# tls-key-file /path/to/redis.key
# tls-ca-cert-file /path/to/ca.crt

# General Configuration
daemonize no
pidfile /var/run/redis/redis-server.pid
loglevel notice
logfile ""

# Database Configuration
databases 16
save 900 1
save 300 10
save 60 10000

# Memory Management
maxmemory ${REDIS_MAX_MEMORY:-512mb}
maxmemory-policy allkeys-lru

# Persistence Configuration
# RDB (Redis Database) snapshots
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /var/lib/redis/

# AOF (Append Only File) persistence
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes
aof-use-rdb-preamble yes

# Replication Configuration (for clustering)
# replica-serve-stale-data yes
# replica-read-only yes
# repl-diskless-sync no
# repl-diskless-sync-delay 5
# repl-ping-replica-period 10
# repl-timeout 60
# repl-backlog-size 1mb
# repl-backlog-ttl 3600

# Security and Access Control
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command KEYS ""
# rename-command DEBUG ""

# Client Configuration
timeout 300
tcp-keepalive 300
tcp-backlog 511

# Slow Log Configuration
slowlog-log-slower-than 10000
slowlog-max-len 128

# Latency Monitoring
latency-monitor-threshold 100

# Event Notification (Keyspace Notifications)
notify-keyspace-events "Ex"

# Advanced Configuration
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
hll-sparse-max-bytes 3000
stream-node-max-bytes 4096
stream-node-max-entries 100

# Active Rehashing
activerehashing yes

# Client Output Buffer Limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Client Query Buffer Limit
client-query-buffer-limit 1gb

# Protocol Max Bulk Request Size
proto-max-bulk-len 512mb

# Frequency of rehashing
hz 10

# Dynamic HZ
dynamic-hz yes

# AOF Rewrite Incremental fsync
aof-rewrite-incremental-fsync yes

# RDB Save Incremental fsync
rdb-save-incremental-fsync yes

# Module Configuration (for Redis modules)
# loadmodule /path/to/redisearch.so
# loadmodule /path/to/redisjson.so
# loadmodule /path/to/redistimeseries.so

# Monitoring and Metrics
# Enable command stats for monitoring
# CONFIG SET commandstats yes

# Cluster Configuration (uncomment for Redis Cluster)
# cluster-enabled yes
# cluster-config-file nodes-6379.conf
# cluster-node-timeout 15000
# cluster-announce-ip ${REDIS_CLUSTER_IP}
# cluster-announce-port 6379
# cluster-announce-bus-port 16379

# Sentinel Configuration (uncomment for Redis Sentinel)
# port 26379
# sentinel monitor mymaster redis-master 6379 2
# sentinel down-after-milliseconds mymaster 5000
# sentinel failover-timeout mymaster 10000
# sentinel parallel-syncs mymaster 1

# Custom Configuration for Aether Vault
# Session storage
session:ttl ${REDIS_SESSION_TTL:-86400}

# Cache configuration
cache:ttl ${REDIS_CACHE_TTL:-3600}

# Rate limiting
rate-limit:window ${REDIS_RATE_LIMIT_WINDOW:-900}
rate-limit:max ${REDIS_RATE_LIMIT_MAX:-100}

# Email queue
email-queue:max-length ${REDIS_EMAIL_QUEUE_MAX:-10000}

# User preferences
user-prefs:ttl ${REDIS_USER_PREFS_TTL:-604800}

# API response caching
api-cache:ttl ${REDIS_API_CACHE_TTL:-300}

# Health check data
health:ttl ${REDIS_HEALTH_TTL:-60}

# Monitoring metrics
metrics:ttl ${REDIS_METRICS_TTL:-300}
metrics:retention ${REDIS_METRICS_RETENTION:-86400}

# Security events
security-events:ttl ${REDIS_SECURITY_TTL:-604800}
security-events:max-entries ${REDIS_SECURITY_MAX:-10000}

# Domain verification tokens
domain-verify:ttl ${REDIS_DOMAIN_VERIFY_TTL:-86400}

# Email verification tokens
email-verify:ttl ${REDIS_EMAIL_VERIFY_TTL:-3600}

# Password reset tokens
password-reset:ttl ${REDIS_PASSWORD_RESET_TTL:-1800}

# Two-factor authentication codes
2fa:ttl ${REDIS_2FA_TTL:-300}

# API keys
api-keys:ttl ${REDIS_API_KEYS_TTL:-0}  # No expiration for API keys

# Temporary data
temp:ttl ${REDIS_TEMP_TTL:-300}

# Background job queue
job-queue:max-length ${REDIS_JOB_QUEUE_MAX:-5000}
job-queue:retry-delay ${REDIS_JOB_RETRY_DELAY:-60}
job-queue:max-retries ${REDIS_JOB_MAX_RETRIES:-3}

# File upload temporary storage
uploads:ttl ${REDIS_UPLOADS_TTL:-3600}
uploads:max-size ${REDIS_UPLOADS_MAX:-104857600}  # 100MB

# Real-time notifications
notifications:ttl ${REDIS_NOTIFICATIONS_TTL:-86400}
notifications:max-per-user ${REDIS_NOTIFICATIONS_MAX:-100}

# Search index cache
search:ttl ${REDIS_SEARCH_TTL:-1800}
search:max-results ${REDIS_SEARCH_MAX:-1000}

# Audit logs
audit:ttl ${REDIS_AUDIT_TTL:-2592000}  # 30 days
audit:max-entries ${REDIS_AUDIT_MAX:-100000}

# Performance monitoring
perf:ttl ${REDIS_PERF_TTL:-300}
perf:sample-rate ${REDIS_PERF_SAMPLE:-0.1}

# Development overrides (uncomment for development)
# save ""
# appendonly no
# maxmemory 256mb